<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Madden Optimizer - DraftKings</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            <h1>NFL Madden Optimizer</h1>
            <span>DraftKings</span>
        </div>
        <div class="header-right">
            <div id="fileStatus" style="font-size: 0.85rem; color: var(--text-muted);">No file loaded</div>
        </div>
    </header>

    <!-- Main Tab Navigation -->
    <nav class="main-tabs">
        <div class="main-tab active" data-tab="showdown">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Madden SD
        </div>
        <div class="main-tab" data-tab="classic">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Madden Classic
            <span style="font-size: 0.6rem; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; color: var(--text-muted);">Soon</span>
        </div>
        <div class="main-tab" data-tab="playerdata">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            Player Data
            <span style="font-size: 0.6rem; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; color: var(--text-muted);">Soon</span>
        </div>
    </nav>

    <!-- Showdown Tab Content -->
    <div class="tab-content active" id="showdownTab">
        <div class="container">
            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-card green">
                    <div class="stat-card-label">DK Entries</div>
                    <div class="stat-card-value" id="entriesLoaded">0</div>
                    <div class="stat-card-sub">Contest entries</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-card-label">Players Loaded</div>
                    <div class="stat-card-value" id="playersLoaded">0</div>
                    <div class="stat-card-sub">From CSV</div>
                </div>
                <div class="stat-card cyan">
                    <div class="stat-card-label">Lineups Generated</div>
                    <div class="stat-card-value" id="lineupsGenerated">0</div>
                    <div class="stat-card-sub">Optimized</div>
                </div>
                <div class="stat-card amber">
                    <div class="stat-card-label">Top Projection</div>
                    <div class="stat-card-value positive" id="topProjection">0.00</div>
                    <div class="stat-card-sub">Best Lineup</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-card-label">Avg Projection</div>
                    <div class="stat-card-value" id="avgProjection">0.00</div>
                    <div class="stat-card-sub">All Lineups</div>
                </div>
            </div>

            <!-- Upload & Settings Section -->
            <div class="grid-2">
                <!-- Upload Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            Upload DraftKings Export
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Slate Selector -->
                        <div class="slate-selector" id="slateSelector">
                            <button class="slate-btn" data-slate="1">
                                <span class="slate-num">1</span>
                                <span class="slate-time">12:00</span>
                            </button>
                            <button class="slate-btn" data-slate="2">
                                <span class="slate-num">2</span>
                                <span class="slate-time">2:00</span>
                            </button>
                            <button class="slate-btn" data-slate="3">
                                <span class="slate-num">3</span>
                                <span class="slate-time">4:00</span>
                            </button>
                            <button class="slate-btn" data-slate="4">
                                <span class="slate-num">4</span>
                                <span class="slate-time">6:00</span>
                            </button>
                            <button class="slate-btn" data-slate="5">
                                <span class="slate-num">5</span>
                                <span class="slate-time">8:00</span>
                            </button>
                            <button class="slate-btn" data-slate="6">
                                <span class="slate-num">6</span>
                                <span class="slate-time">10:00</span>
                            </button>
                        </div>
                        
                        <!-- Current Slate Info -->
                        <div class="current-slate-info" id="currentSlateInfo">
                            <div class="slate-info-row">
                                <div class="slate-info-left">
                                    <div class="slate-badge" id="slateBadge">1</div>
                                    <div class="slate-details">
                                        <span class="teams" id="slateTeams">ATL @ TB</span>
                                        <span class="datetime" id="slateDateTime">11/24/2025 12:00 PM ET</span>
                                    </div>
                                </div>
                                <div class="slate-info-right">
                                    <span><span class="count" id="slatePlayerCount">0</span> players</span>
                                    <span><span class="count" id="slateEntryCount">0</span> entries</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="upload-zone" id="uploadZone">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <h3>Drop your DraftKings CSV here</h3>
                            <p>Entries + Player Pool export file</p>
                            <input type="file" id="csvInput" accept=".csv">
                        </div>
                    </div>
                </div>

                <!-- Settings Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Optimizer Settings
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="slider-group">
                            <div class="slider-header">
                                <label class="settings-label">Salary Range</label>
                                <span class="slider-values">$<span id="minSalaryValue">49,000</span> - $<span id="maxSalaryValue">50,000</span></span>
                            </div>
                            <div class="dual-slider-container">
                                <div class="slider-track"></div>
                                <div class="slider-range" id="salaryRange"></div>
                                <input type="range" class="dual-slider" id="minSalarySlider" min="40000" max="50000" value="49000" step="100">
                                <input type="range" class="dual-slider" id="maxSalarySlider" min="40000" max="50000" value="50000" step="100">
                            </div>
                            <div class="slider-labels">
                                <span>$40,000</span>
                                <span>$50,000</span>
                            </div>
                        </div>

                        <div class="slider-group">
                            <div class="slider-header">
                                <label class="settings-label">Projection Floor</label>
                                <span class="slider-value-highlight" id="projFloorValue">90.0%</span>
                            </div>
                            <input type="range" class="single-slider" id="projFloorSlider" min="80" max="100" value="90" step="0.5">
                            <div class="slider-labels">
                                <span>80%</span>
                                <span>100%</span>
                            </div>
                            <p class="slider-hint">Only include lineups within this % of the top projection</p>
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">Number of Lineups to Generate</label>
                            <div class="settings-row">
                                <button class="lineup-count-btn active" data-count="100">100</button>
                                <button class="lineup-count-btn" data-count="500">500</button>
                                <button class="lineup-count-btn" data-count="2000">2,000</button>
                                <button class="lineup-count-btn" data-count="5000">5,000</button>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label class="settings-label">Or Generate for Time Duration</label>
                            <div class="settings-row">
                                <button class="lineup-time-btn" data-seconds="10">10 sec</button>
                                <button class="lineup-time-btn" data-seconds="20">20 sec</button>
                                <button class="lineup-time-btn" data-seconds="30">30 sec</button>
                                <button class="lineup-time-btn" data-seconds="60">1 min</button>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg" id="generateBtn" style="width: 100%;" disabled>
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Generate Lineups
                        </button>

                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="progressText">Generating lineups...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player Pool -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Player Pool
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        <span id="playerCount">0</span> players
                    </div>
                </div>
                <div class="card-body" style="padding: 16px 20px 0;">
                    <div class="filter-pills" id="positionFilters">
                        <span class="filter-pill active" data-pos="all">All</span>
                        <span class="filter-pill" data-pos="QB">QB</span>
                        <span class="filter-pill" data-pos="RB">RB</span>
                        <span class="filter-pill" data-pos="WR">WR</span>
                        <span class="filter-pill" data-pos="TE">TE</span>
                        <span class="filter-pill" data-pos="K">K</span>
                        <span class="filter-pill" data-pos="DST">DST</span>
                    </div>
                    <div class="search-input">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="playerSearch" placeholder="Search players...">
                    </div>
                </div>
                <div class="table-container" id="playerPoolContainer">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <h4>No Players Loaded</h4>
                        <p>Upload a CSV file to load player projections</p>
                    </div>
                </div>
            </div>

            <!-- Generated Lineups -->
            <div class="card" id="lineupsCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Generated Lineups
                    </div>
                    <div class="export-section">
                        <span style="font-size: 0.8rem; color: var(--text-muted);" id="lineupCountDisplay">0 lineups</span>
                        <button class="btn btn-secondary" id="clearLineupsBtn">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Clear
                        </button>
                        <button class="btn btn-secondary" id="exportBtn">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            Export CSV
                        </button>
                    </div>
                </div>
                <div class="pagination-container" id="paginationTop" style="display: none;">
                    <div class="pagination">
                        <button class="pagination-btn" id="prevPageTop" disabled>
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                            Prev
                        </button>
                        <span class="pagination-info" id="pageInfoTop">Page 1 of 1</span>
                        <button class="pagination-btn" id="nextPageTop">
                            Next
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    <span class="pagination-showing" id="showingInfoTop">Showing 1-100</span>
                </div>
                <div class="lineup-output" id="lineupOutput">
                    <div class="lineup-row header">
                        <div class="sortable" data-sort="rank">Rank</div>
                        <div>CPT</div>
                        <div>FLEX</div>
                        <div>FLEX</div>
                        <div>FLEX</div>
                        <div>FLEX</div>
                        <div>FLEX</div>
                        <div class="sortable" data-sort="salary">Salary</div>
                        <div class="sortable sort-desc" data-sort="points">Points</div>
                    </div>
                    <div id="lineupRows"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Classic Tab Content (Placeholder) -->
    <div class="tab-content" id="classicTab">
        <div class="container">
            <div class="empty-state" style="padding: 100px 20px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 80px; height: 80px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
                <h4>Madden Classic Coming Soon</h4>
                <p>9-position classic optimizer with correlation stacking</p>
            </div>
        </div>
    </div>

    <!-- Player Data Tab Content (Placeholder) -->
    <div class="tab-content" id="playerdataTab">
        <div class="container">
            <div class="empty-state" style="padding: 100px 20px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 80px; height: 80px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <h4>Player Data & Correlations Coming Soon</h4>
                <p>Upload historical data to compute player correlations</p>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="js/core/utils.js"></script>
    <script src="js/sports/madden/config.js"></script>
    <script src="js/sports/madden/showdown.js"></script>
    
    <!-- App Controller -->
    <script>
        // ==========================================
        // APP CONTROLLER
        // Connects UI events to MaddenShowdown logic
        // ==========================================
        
        (function() {
            'use strict';
            
            // DOM Elements
            const uploadZone = document.getElementById('uploadZone');
            const csvInput = document.getElementById('csvInput');
            const generateBtn = document.getElementById('generateBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const playerPoolContainer = document.getElementById('playerPoolContainer');
            const lineupsCard = document.getElementById('lineupsCard');
            const lineupRows = document.getElementById('lineupRows');
            
            // Initialize
            console.log('Showdown Optimizer initializing...');
            
            // ==========================================
            // FILE UPLOAD HANDLERS
            // ==========================================
            
            uploadZone.addEventListener('click', () => csvInput.click());
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    handleFile(file);
                }
            });

            csvInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file);
                }
                csvInput.value = '';
            });
            
            function handleFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Use MaddenShowdown's parseCSV
                    const contestsMap = MaddenShowdown.parseCSV(e.target.result, file.name);
                    
                    // Update UI
                    updateSlateButtons();
                    updateSlateInfo();
                    updateStats();
                    renderPlayerPool();
                    
                    document.getElementById('fileStatus').textContent = `Slate ${MaddenShowdown.currentSlate} loaded`;
                    generateBtn.disabled = MaddenShowdown.players.length === 0;
                };
                reader.readAsText(file);
            }
            
            // ==========================================
            // SLATE SELECTION
            // ==========================================
            
            document.querySelectorAll('.slate-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const slateNum = parseInt(btn.dataset.slate);
                    if (MaddenShowdown.selectSlate(slateNum)) {
                        updateSlateButtons();
                        updateSlateInfo();
                        updateStats();
                        renderPlayerPool();
                        renderLineups();
                    }
                });
            });
            
            function updateSlateButtons() {
                document.querySelectorAll('.slate-btn').forEach(btn => {
                    const slateNum = parseInt(btn.dataset.slate);
                    btn.classList.remove('active', 'loaded');
                    
                    if (MaddenShowdown.slates[slateNum]) {
                        btn.classList.add('loaded');
                    }
                    if (slateNum === MaddenShowdown.currentSlate) {
                        btn.classList.add('active');
                    }
                });
            }
            
            function updateSlateInfo() {
                const infoEl = document.getElementById('currentSlateInfo');
                if (!MaddenShowdown.currentSlate || !MaddenShowdown.slates[MaddenShowdown.currentSlate]) {
                    infoEl.classList.remove('visible');
                    return;
                }
                
                const slate = MaddenShowdown.slates[MaddenShowdown.currentSlate];
                infoEl.classList.add('visible');
                document.getElementById('slateBadge').textContent = MaddenShowdown.currentSlate;
                document.getElementById('slateTeams').textContent = slate.teams || 'Unknown';
                document.getElementById('slateDateTime').textContent = slate.dateTime || '';
                document.getElementById('slatePlayerCount').textContent = slate.players.length;
                document.getElementById('slateEntryCount').textContent = slate.entries.length;
            }
            
            function updateStats() {
                const stats = MaddenShowdown.getStats();
                document.getElementById('playersLoaded').textContent = stats.playerCount;
                document.getElementById('playerCount').textContent = stats.playerCount;
                document.getElementById('entriesLoaded').textContent = stats.entryCount;
                document.getElementById('lineupsGenerated').textContent = stats.lineupCount;
                document.getElementById('topProjection').textContent = stats.topProjection.toFixed(2);
                document.getElementById('avgProjection').textContent = stats.avgProjection.toFixed(2);
            }
            
            // ==========================================
            // SETTINGS
            // ==========================================
            
            // Salary Range Sliders
            const minSalarySlider = document.getElementById('minSalarySlider');
            const maxSalarySlider = document.getElementById('maxSalarySlider');
            const minSalaryValue = document.getElementById('minSalaryValue');
            const maxSalaryValue = document.getElementById('maxSalaryValue');
            const salaryRange = document.getElementById('salaryRange');

            function updateSalaryRange() {
                const minVal = parseInt(minSalarySlider.value);
                const maxVal = parseInt(maxSalarySlider.value);
                
                if (minVal > maxVal - 100) {
                    if (this === minSalarySlider) {
                        minSalarySlider.value = maxVal - 100;
                    } else {
                        maxSalarySlider.value = minVal + 100;
                    }
                }
                
                MaddenShowdown.minSalary = parseInt(minSalarySlider.value);
                MaddenShowdown.maxSalary = parseInt(maxSalarySlider.value);
                
                minSalaryValue.textContent = MaddenShowdown.minSalary.toLocaleString();
                maxSalaryValue.textContent = MaddenShowdown.maxSalary.toLocaleString();
                
                const minPercent = ((MaddenShowdown.minSalary - 40000) / 10000) * 100;
                const maxPercent = ((MaddenShowdown.maxSalary - 40000) / 10000) * 100;
                salaryRange.style.left = minPercent + '%';
                salaryRange.style.width = (maxPercent - minPercent) + '%';
            }

            minSalarySlider.addEventListener('input', updateSalaryRange);
            maxSalarySlider.addEventListener('input', updateSalaryRange);
            updateSalaryRange();

            // Projection Floor Slider
            const projFloorSlider = document.getElementById('projFloorSlider');
            const projFloorValue = document.getElementById('projFloorValue');

            function updateProjFloor() {
                MaddenShowdown.projectionFloor = parseFloat(projFloorSlider.value);
                projFloorValue.textContent = MaddenShowdown.projectionFloor.toFixed(1) + '%';
                
                const percent = ((MaddenShowdown.projectionFloor - 80) / 20) * 100;
                projFloorSlider.style.background = `linear-gradient(to right, var(--accent-tertiary) ${percent}%, var(--bg-input) ${percent}%)`;
            }

            projFloorSlider.addEventListener('input', updateProjFloor);
            updateProjFloor();

            // Lineup Count Selection
            document.querySelectorAll('.lineup-count-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.lineup-count-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.lineup-time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    MaddenShowdown.selectedLineupCount = parseInt(btn.dataset.count);
                    MaddenShowdown.selectedTimeSeconds = null;
                    MaddenShowdown.generationMode = 'count';
                });
            });

            // Lineup Time Selection
            document.querySelectorAll('.lineup-time-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.lineup-time-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.lineup-count-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    MaddenShowdown.selectedTimeSeconds = parseInt(btn.dataset.seconds);
                    MaddenShowdown.selectedLineupCount = null;
                    MaddenShowdown.generationMode = 'time';
                });
            });
            
            // ==========================================
            // GENERATE LINEUPS
            // ==========================================
            
            generateBtn.addEventListener('click', async () => {
                generateBtn.disabled = true;
                progressContainer.classList.add('active');
                lineupsCard.style.display = 'block';
                
                try {
                    await MaddenShowdown.generateLineups((progress, count, text) => {
                        progressFill.style.width = progress + '%';
                        progressText.textContent = text;
                    });
                    
                    updateStats();
                    renderLineups();
                    
                    setTimeout(() => {
                        progressContainer.classList.remove('active');
                        generateBtn.disabled = false;
                    }, 1500);
                    
                } catch (error) {
                    console.error('Generation error:', error);
                    progressText.textContent = 'Error: ' + error.message;
                    generateBtn.disabled = false;
                }
            });
            
            // ==========================================
            // PLAYER POOL RENDERING
            // ==========================================
            
            function renderPlayerPool(filter = 'all', search = '') {
                if (MaddenShowdown.players.length === 0) {
                    playerPoolContainer.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <h4>No Players Loaded</h4>
                            <p>Upload a CSV file to load player projections</p>
                        </div>
                    `;
                    return;
                }

                let filteredPlayers = [...MaddenShowdown.players];
                
                if (filter !== 'all') {
                    filteredPlayers = filteredPlayers.filter(p => 
                        p.position.toUpperCase() === filter.toUpperCase() ||
                        (filter === 'DST' && (p.position === 'DEF' || p.position === 'DST'))
                    );
                }

                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredPlayers = filteredPlayers.filter(p => 
                        p.name.toLowerCase().includes(searchLower) ||
                        p.team.toLowerCase().includes(searchLower)
                    );
                }

                // Sort by projection
                filteredPlayers.sort((a, b) => b.flexProjection - a.flexProjection);

                document.getElementById('playerCount').textContent = filteredPlayers.length;

                playerPoolContainer.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Pos</th>
                                <th>Team</th>
                                <th>FLEX Salary</th>
                                <th>CPT Salary</th>
                                <th>FLEX Proj</th>
                                <th>CPT Proj</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredPlayers.map(p => `
                                <tr>
                                    <td style="font-weight: 500;">${p.name}</td>
                                    <td><span class="position-badge ${p.position.toLowerCase()}">${p.position}</span></td>
                                    <td class="team-badge">${p.team}</td>
                                    <td>$${p.flexSalary.toLocaleString()}</td>
                                    <td>$${Math.round(p.flexSalary * 1.5).toLocaleString()}</td>
                                    <td style="color: var(--accent-primary); font-weight: 600;">${p.flexProjection.toFixed(2)}</td>
                                    <td style="color: var(--accent-tertiary); font-weight: 600;">${(p.flexProjection * 1.5).toFixed(2)}</td>
                                    <td>${p.value.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // Position Filter
            document.getElementById('positionFilters').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-pill')) {
                    document.querySelectorAll('#positionFilters .filter-pill').forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    renderPlayerPool(e.target.dataset.pos, document.getElementById('playerSearch').value);
                }
            });

            // Search
            document.getElementById('playerSearch').addEventListener('input', (e) => {
                const activeFilter = document.querySelector('#positionFilters .filter-pill.active').dataset.pos;
                renderPlayerPool(activeFilter, e.target.value);
            });
            
            // ==========================================
            // LINEUP RENDERING
            // ==========================================
            
            function renderLineups() {
                const lineups = MaddenShowdown.lineups;
                document.getElementById('lineupCountDisplay').textContent = `${lineups.length} lineups`;

                const paginationTop = document.getElementById('paginationTop');

                if (lineups.length === 0) {
                    paginationTop.style.display = 'none';
                    lineupRows.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            <h4>No Lineups Generated</h4>
                            <p>Click "Generate Lineups" to create optimized lineups</p>
                        </div>
                    `;
                    return;
                }

                // Pagination
                const lineupsPerPage = 100;
                const totalPages = Math.ceil(lineups.length / lineupsPerPage);
                let currentPage = MaddenShowdown.currentPage;
                currentPage = Math.min(currentPage, totalPages);
                currentPage = Math.max(currentPage, 1);
                MaddenShowdown.currentPage = currentPage;
                
                const startIdx = (currentPage - 1) * lineupsPerPage;
                const endIdx = Math.min(startIdx + lineupsPerPage, lineups.length);
                const pageLineups = lineups.slice(startIdx, endIdx);

                if (lineups.length > lineupsPerPage) {
                    paginationTop.style.display = 'flex';
                    document.getElementById('pageInfoTop').textContent = `Page ${currentPage} of ${totalPages}`;
                    document.getElementById('showingInfoTop').textContent = `Showing ${startIdx + 1}-${endIdx} of ${lineups.length}`;
                    document.getElementById('prevPageTop').disabled = currentPage <= 1;
                    document.getElementById('nextPageTop').disabled = currentPage >= totalPages;
                } else {
                    paginationTop.style.display = 'none';
                }

                lineupRows.innerHTML = pageLineups.map((lineup, idx) => {
                    const cpt = lineup.players[0];
                    const flex = lineup.players.slice(1);
                    const actualRank = startIdx + idx + 1;
                    
                    return `
                        <div class="lineup-row">
                            <div class="lineup-rank">#${actualRank}</div>
                            <div class="lineup-player">
                                <span class="lineup-player-name">${cpt.name}</span>
                                <span class="lineup-player-meta">
                                    <span class="position-badge cpt">CPT</span>
                                    ${cpt.team} • $${(cpt.cptSalary || Math.round(cpt.flexSalary * 1.5)).toLocaleString()} • <span style="color: var(--accent-tertiary); font-weight: 600;">${(cpt.flexProjection * 1.5).toFixed(1)}</span>
                                </span>
                            </div>
                            ${flex.map(p => `
                                <div class="lineup-player">
                                    <span class="lineup-player-name">${p.name}</span>
                                    <span class="lineup-player-meta">
                                        <span class="position-badge flex">FLEX</span>
                                        ${p.team} • $${p.flexSalary.toLocaleString()} • <span style="color: var(--accent-primary); font-weight: 600;">${p.flexProjection.toFixed(1)}</span>
                                    </span>
                                </div>
                            `).join('')}
                            <div class="lineup-salary">$${lineup.totalSalary.toLocaleString()}</div>
                            <div class="lineup-points">${lineup.totalProjection.toFixed(2)}</div>
                        </div>
                    `;
                }).join('');
            }

            // Pagination
            document.getElementById('prevPageTop').addEventListener('click', () => {
                if (MaddenShowdown.currentPage > 1) {
                    MaddenShowdown.currentPage--;
                    renderLineups();
                    document.getElementById('lineupOutput').scrollTop = 0;
                }
            });

            document.getElementById('nextPageTop').addEventListener('click', () => {
                const totalPages = Math.ceil(MaddenShowdown.lineups.length / 100);
                if (MaddenShowdown.currentPage < totalPages) {
                    MaddenShowdown.currentPage++;
                    renderLineups();
                    document.getElementById('lineupOutput').scrollTop = 0;
                }
            });

            // Export CSV
            document.getElementById('exportBtn').addEventListener('click', () => {
                const csvContent = MaddenShowdown.exportCSV();
                if (csvContent) {
                    Utils.downloadFile(csvContent, `showdown_lineups_${Utils.getTodayString()}.csv`);
                }
            });

            // Clear Lineups
            document.getElementById('clearLineupsBtn').addEventListener('click', () => {
                MaddenShowdown.lineups = [];
                MaddenShowdown.currentPage = 1;
                if (MaddenShowdown.currentSlate && MaddenShowdown.slates[MaddenShowdown.currentSlate]) {
                    MaddenShowdown.slates[MaddenShowdown.currentSlate].lineups = [];
                }
                updateStats();
                document.getElementById('paginationTop').style.display = 'none';
                lineupRows.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <h4>No Lineups Generated</h4>
                        <p>Click "Generate Lineups" to create optimized lineups</p>
                    </div>
                `;
            });
            
            // ==========================================
            // TAB NAVIGATION
            // ==========================================
            
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabName + 'Tab').classList.add('active');
                });
            });
            
            // Initialize player pool
            renderPlayerPool();
            
            console.log('Showdown Optimizer ready!');
            
        })();
    </script>
</body>
</html>
